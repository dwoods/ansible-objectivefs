---

- include: debian.yml
  when: ansible_os_family == 'Debian'
  tags: package

- include: redhat.yml
  when: ansible_os_family == 'RedHat'
  tags: package

- name: Make sure objectivefs config dir exists
  file:
    path: /etc/objectivefs.env
    state: directory

- copy: content="{{ item.content }}" dest=/etc/objectivefs.env/{{ item.filename }}
  with_items:
    - { content: '{{ aws_access_key_id }}', filename: 'AWS_ACCESS_KEY_ID' }
    - { content: '{{ aws_secret_access_key }}', filename: 'AWS_SECRET_ACCESS_KEY' }
    - { content: '{{ objectivefs_licence }}', filename: 'OBJECTIVEFS_LICENSE' }
    - { content: '{{ objectivefs_passphrase }}', filename: 'OBJECTIVEFS_PASSPHRASE' }

- name: Make sure mount point exists
  file:
    path: "{{ objectivefs_mountpoint }}"
    state: directory

- name: Add to fstab
  - mount: "name={{ objectivefs_mountpoint }} src={{ objectivefs_filesystem }} fstype=objectivefs opts=auto,_netdev state=mounted"

- name: Mount drive
  command: "mount.objectivefs {{ objectivefs_filesystem }} {{ objectivefs_mountpoint }}"
  args:
    creates: "{{ objectivefs_mountpoint }}/README"
  sudo: true

- include: symlinks.yml
  when: objectivefs_create_symlinks